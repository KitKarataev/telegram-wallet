<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; margin: 0; }
        
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        input { flex: 1; padding: 12px; border-radius: 12px; border: 1px solid #334155; background: #1e293b; color: white; font-size: 16px; outline: none; }
        button.add-btn { padding: 12px 20px; background-color: #3b82f6; color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; }
        
        .chart-box { background: #1e293b; border-radius: 16px; padding: 15px; margin-bottom: 20px; }
        .chart-container { position: relative; height: 250px; width: 100%; }

        h2 { font-size: 18px; margin-bottom: 10px; color: #94a3b8; }
        .history-list { list-style: none; padding: 0; margin: 0; }
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #334155; }
        
        .cat-badge { font-size: 12px; background: #334155; padding: 4px 8px; border-radius: 6px; margin-right: 8px; color: #cbd5e1; }
        .amount { font-weight: bold; color: #3b82f6; margin-right: 10px;}
        
        /* Кнопка удаления */
        .del-btn { background: none; border: none; color: #ef4444; font-size: 18px; cursor: pointer; padding: 0 5px; opacity: 0.7; }
        .del-btn:active { opacity: 1; transform: scale(1.2); }
    </style>
</head>
<body>
    <div class="input-group">
        <input type="text" id="expense" placeholder="Такси 500">
        <button class="add-btn" onclick="sendData()">OK</button>
    </div>

    <div class="chart-box">
        <div class="chart-container">
            <canvas id="myChart"></canvas>
        </div>
    </div>

    <h2>История</h2>
    <ul id="history" class="history-list">
        <li style="text-align:center; color: #666;">Загрузка...</li>
    </ul>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        if (tg.colorScheme === 'light') {
            document.body.style.backgroundColor = '#f8fafc';
            document.body.style.color = '#0f172a';
        }

        let myChart = null;
        const user_id = tg.initDataUnsafe?.user?.id || 12345;

        async function sendData() {
            const input = document.getElementById('expense');
            if(!input.value) return;
            tg.HapticFeedback.impactOccurred('medium');
            
            await fetch('/api/index', {
                method: 'POST',
                body: JSON.stringify({ text: input.value, user_id: user_id })
            });
            input.value = "";
            loadStats(); 
        }

        // Функция удаления
        async function deleteItem(id) {
            if(!confirm("Удалить?")) return;
            await fetch('/api/delete', {
                method: 'POST',
                body: JSON.stringify({ id: id })
            });
            tg.HapticFeedback.notificationOccurred('success');
            loadStats();
        }

        async function loadStats() {
            const res = await fetch(`/api/stats?user_id=${user_id}`);
            const data = await res.json();

            // График
            const ctx = document.getElementById('myChart');
            if (myChart) myChart.destroy();
            
            const chartData = data.chart.data.length ? data.chart.data : [1];
            const chartLabels = data.chart.labels.length ? data.chart.labels : ['Пусто'];
            const chartColors = data.chart.data.length 
                ? ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6'] 
                : ['#334155'];

            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        data: chartData,
                        backgroundColor: chartColors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    cutout: '75%'
                }
            });

            // История с кнопкой удаления
            const list = document.getElementById('history');
            list.innerHTML = "";

            if (data.history.length === 0) {
                list.innerHTML = "<li class='history-item' style='justify-content:center'>Нет записей</li>";
            } else {
                data.history.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'history-item';
                    li.innerHTML = `
                        <div style="display:flex; align-items:center">
                            <span class="cat-badge">${item.category}</span>
                            <span>${item.description}</span>
                        </div>
                        <div style="display:flex; align-items:center">
                            <span class="amount">${item.amount}</span>
                            <button class="del-btn" onclick="deleteItem(${item.id})">×</button>
                        </div>
                    `;
                    list.appendChild(li);
                });
            }
        }
        loadStats();
    </script>
</body>
</html>
