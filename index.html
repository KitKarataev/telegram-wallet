<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <style>
        body { background-color: #111; color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; box-sizing: border-box; }
        input { padding: 15px; border-radius: 12px; border: 1px solid #333; background: #222; color: white; width: 100%; font-size: 16px; margin-bottom: 10px; outline: none; }
        button { padding: 15px; background-color: #3b82f6; color: white; border: none; border-radius: 12px; font-size: 16px; width: 100%; cursor: pointer; font-weight: bold; }
        button:active { opacity: 0.8; }
        .chart-container { position: relative; height: 300px; width: 100%; margin-top: 30px; }
        h1 { margin-bottom: 20px; font-size: 24px; }
        .status { margin-top: 10px; font-size: 14px; color: #888; }
    </style>
</head>
<body>
    <h1>üí∏ –ú–æ–∏ –†–∞—Å—Ö–æ–¥—ã</h1>
    
    <div style="width: 100%;">
        <input type="text" id="expense" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–∏—Ü—Ü–∞ 800">
        <button onclick="sendData()">–î–û–ë–ê–í–ò–¢–¨ –¢–†–ê–¢–£</button>
        <p id="status" class="status"></p>
    </div>

    <div class="chart-container">
        <canvas id="myChart"></canvas>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
        let myChart = null;

        // 1. –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
        async function sendData() {
            const input = document.getElementById('expense');
            const status = document.getElementById('status');
            
            if(!input.value) return;

            status.innerText = "–î—É–º–∞—é...";
            const user_id = tg.initDataUnsafe?.user?.id || 12345;

            await fetch('/api/index', {
                method: 'POST',
                body: JSON.stringify({ text: input.value, user_id: user_id })
            });

            status.innerText = "‚úÖ –£–ª–µ—Ç–µ–ª–æ –≤ –±–∞–∑—É!";
            input.value = "";
            loadStats(); // –°—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫
        }

        // 2. –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞
        async function loadStats() {
            const ctx = document.getElementById('myChart');
            
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ —É –Ω–∞—à–µ–≥–æ –Ω–æ–≤–æ–≥–æ Python-—Å–∫—Ä–∏–ø—Ç–∞
            const res = await fetch('/api/stats');
            const data = await res.json();

            // –ï—Å–ª–∏ –≥—Ä–∞—Ñ–∏–∫ —É–∂–µ –µ—Å—Ç—å - —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π
            if (myChart) myChart.destroy();

            // –†–∏—Å—É–µ–º –Ω–æ–≤—ã–π
            myChart = new Chart(ctx, {
                type: 'doughnut', // –¢–∏–ø: –ü–æ–Ω—á–∏–∫
                data: {
                    labels: data.labels,
                    datasets: [{
                        data: data.data,
                        backgroundColor: ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: 'white' } }
                    }
                }
            });
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –≥—Ä–∞—Ñ–∏–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadStats();
    </script>
</body>
</html>
