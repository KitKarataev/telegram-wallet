<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 20px; margin: 0; }
        
        /* Стиль ввода */
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        input { flex: 1; padding: 12px; border-radius: 12px; border: 1px solid #334155; background: #1e293b; color: white; font-size: 16px; outline: none; }
        button { padding: 12px 20px; background-color: #3b82f6; color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; }
        button:active { transform: scale(0.98); }

        /* График */
        .chart-box { background: #1e293b; border-radius: 16px; padding: 15px; margin-bottom: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .chart-container { position: relative; height: 250px; width: 100%; }

        /* Список истории */
        h2 { font-size: 18px; margin-bottom: 10px; color: #94a3b8; }
        .history-list { list-style: none; padding: 0; margin: 0; }
        .history-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #334155; }
        .history-item:last-child { border-bottom: none; }
        .cat-badge { font-size: 12px; background: #334155; padding: 4px 8px; border-radius: 6px; margin-right: 8px; color: #cbd5e1; }
        .amount { font-weight: bold; color: #3b82f6; }
    </style>
</head>
<body>
    <div class="input-group">
        <input type="text" id="expense" placeholder="Такси 500">
        <button onclick="sendData()">OK</button>
    </div>

    <div class="chart-box">
        <div class="chart-container">
            <canvas id="myChart"></canvas>
        </div>
    </div>

    <h2>Последние операции</h2>
    <ul id="history" class="history-list">
        <li style="text-align:center; color: #666;">Загрузка...</li>
    </ul>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        // Настраиваем цвета для Телеграма (темная/светлая тема)
        if (tg.colorScheme === 'light') {
            document.body.style.backgroundColor = '#f8fafc';
            document.body.style.color = '#0f172a';
        }

        let myChart = null;
        // Берем ID юзера или используем тестовый, если открыто в браузере
        const user_id = tg.initDataUnsafe?.user?.id || 12345;

        async function sendData() {
            const input = document.getElementById('expense');
            if(!input.value) return;

            // Вибрация телефона (Haptic Feedback) - фишка Телеграма
            tg.HapticFeedback.impactOccurred('medium');

            await fetch('/api/index', {
                method: 'POST',
                body: JSON.stringify({ text: input.value, user_id: user_id })
            });

            input.value = "";
            loadStats(); 
        }

        async function loadStats() {
            // ВАЖНО: Теперь мы передаем user_id в ссылке
            const res = await fetch(`/api/stats?user_id=${user_id}`);
            const data = await res.json();

            // 1. Рисуем График
            const ctx = document.getElementById('myChart');
            if (myChart) myChart.destroy();
            
            // Если данных нет, рисуем пустой круг
            const chartData = data.chart.data.length ? data.chart.data : [1];
            const chartLabels = data.chart.labels.length ? data.chart.labels : ['Нет данных'];
            const chartColors = data.chart.data.length 
                ? ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6'] 
                : ['#334155'];

            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        data: chartData,
                        backgroundColor: chartColors,
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    cutout: '70%'
                }
            });

            // 2. Рисуем Историю
            const list = document.getElementById('history');
            list.innerHTML = ""; // Очистить старое

            if (data.history.length === 0) {
                list.innerHTML = "<li class='history-item' style='justify-content:center'>Пока пусто</li>";
            } else {
                data.history.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'history-item';
                    li.innerHTML = `
                        <div>
                            <span class="cat-badge">${item.category}</span>
                            <span>${item.description}</span>
                        </div>
                        <span class="amount">${item.amount} ₽</span>
                    `;
                    list.appendChild(li);
                });
            }
        }

        loadStats();
    </script>
</body>
</html>
