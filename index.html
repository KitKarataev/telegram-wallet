<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: sans-serif; padding: 15px; margin: 0; padding-bottom: 80px; }
        
        /* –¢–∞–±—ã (–ú–µ–Ω—é) */
        .tabs { position: fixed; bottom: 0; left: 0; width: 100%; background: #1e293b; display: flex; padding: 10px 0; border-top: 1px solid #334155; z-index: 100; }
        .tab-item { flex: 1; text-align: center; color: #64748b; cursor: pointer; font-size: 12px; }
        .tab-item.active { color: #3b82f6; font-weight: bold; }
        .tab-icon { font-size: 20px; display: block; margin-bottom: 4px; }

        /* –≠–∫—Ä–∞–Ω—ã */
        .screen { display: none; }
        .screen.active { display: block; }

        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .title { font-size: 18px; font-weight: bold; color: #fff; }
        select { background: #1e293b; color: white; border: 1px solid #334155; padding: 5px; border-radius: 8px; outline: none; }
        
        /* –ö–æ—à–µ–ª–µ–∫ */
        .wallet-card { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); padding: 20px; border-radius: 16px; text-align: center; margin-bottom: 20px; }
        .wallet-amount { font-size: 32px; font-weight: bold; color: white; }
        
        .filters { display: flex; background: #1e293b; padding: 4px; border-radius: 12px; margin-bottom: 15px; }
        .filter-btn { flex: 1; text-align: center; padding: 8px 0; font-size: 13px; color: #94a3b8; border-radius: 8px; cursor: pointer; }
        .filter-btn.active { background: #334155; color: white; }
        
        .period-stats { display: flex; gap: 10px; margin-bottom: 20px; }
        .stat-card { flex: 1; background: #1e293b; padding: 12px; border-radius: 12px; }
        .stat-val { font-size: 16px; font-weight: bold; }
        .green { color: #10b981; } .red { color: #ef4444; }

        /* –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ (–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–∞—è) */
        .input-box { background: #1e293b; padding: 15px; border-radius: 16px; margin-bottom: 20px; }
        
        .type-switch { display: flex; gap: 10px; margin-bottom: 10px; }
        .type-btn { flex: 1; padding: 10px; text-align: center; background: #334155; border-radius: 8px; font-size: 14px; cursor: pointer; color: #94a3b8; transition: 0.2s; }
        .type-btn.active-exp { background: #ef4444; color: white; font-weight: bold; }
        .type-btn.active-inc { background: #10b981; color: white; font-weight: bold; }

        input, select.full { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #334155; background: #0f172a; color: white; font-size: 16px; box-sizing: border-box; margin-bottom: 10px; outline: none;}
        
        button.main-btn { width: 100%; padding: 12px; background: #ef4444; color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        
        /* –ü–æ–¥–ø–∏—Å–∫–∏ */
        .sub-item { background: #1e293b; border-radius: 12px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .sub-del { color: #ef4444; font-size: 20px; padding-left: 15px; cursor: pointer; }

    </style>
</head>
<body>
    
    <div id="screen-wallet" class="screen active">
        <div class="header">
            <div class="title">Wallet AI</div>
            <select id="currency-select" onchange="changeCurrency()">
                <option value="RUB">RUB</option>
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
            </select>
        </div>

        <div class="wallet-card">
            <div style="font-size:14px; color:rgba(255,255,255,0.8)">–û–±—â–∏–π –±–∞–ª–∞–Ω—Å</div>
            <div class="wallet-amount" id="total-balance">...</div>
        </div>

        <div class="filters">
            <div class="filter-btn" onclick="setFilter('day', this)">–î–µ–Ω—å</div>
            <div class="filter-btn" onclick="setFilter('week', this)">–ù–µ–¥–µ–ª—è</div>
            <div class="filter-btn active" onclick="setFilter('month', this)">–ú–µ—Å—è—Ü</div>
        </div>

        <div class="period-stats">
            <div class="stat-card">
                <div style="font-size:12px; color:#94a3b8">–î–æ—Ö–æ–¥</div>
                <div id="inc-val" class="stat-val green">0</div>
            </div>
            <div class="stat-card">
                <div style="font-size:12px; color:#94a3b8">–†–∞—Å—Ö–æ–¥</div>
                <div id="exp-val" class="stat-val red">0</div>
            </div>
        </div>

        <div class="input-box">
            <div class="type-switch">
                <div id="btn-exp" class="type-btn active-exp" onclick="setType('expense')">–†–∞—Å—Ö–æ–¥</div>
                <div id="btn-inc" class="type-btn" onclick="setType('income')">–î–æ—Ö–æ–¥</div>
            </div>
            
            <input type="date" id="date-picker">
            <input type="text" id="expense" placeholder="–°—É–º–º–∞ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ...">
            
            <button class="main-btn" id="submit-btn" onclick="sendData()">–ü–û–¢–†–ê–¢–ò–õ</button>
        </div>
        
        <h3 style="color:#94a3b8; font-size:14px">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</h3>
        <div id="history"></div>
    </div>

    <div id="screen-subs" class="screen">
        <div class="header">
            <div class="title">–ú–æ–∏ –ü–æ–¥–ø–∏—Å–∫–∏</div>
        </div>

        <div class="input-box">
            <input type="text" id="sub-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (Netflix)">
            <input type="number" id="sub-amount" placeholder="–°—É–º–º–∞ (19)">
            <div style="color:#94a3b8; font-size:12px; margin-bottom:5px">–î–∞—Ç–∞ —Å–ª–µ–¥—É—é—â–µ–π –æ–ø–ª–∞—Ç—ã:</div>
            <input type="date" id="sub-date">
            <select id="sub-period" class="full">
                <option value="month">–ö–∞–∂–¥—ã–π –º–µ—Å—è—Ü</option>
                <option value="year">–ö–∞–∂–¥—ã–π –≥–æ–¥</option>
            </select>
            <button class="main-btn" style="background:#3b82f6" onclick="addSub()">–î–û–ë–ê–í–ò–¢–¨ –ü–û–î–ü–ò–°–ö–£</button>
        </div>

        <div id="subs-list"></div>
    </div>

    <div class="tabs">
        <div class="tab-item active" onclick="switchTab('wallet', this)">
            <span class="tab-icon">üí≥</span>–ö–æ—à–µ–ª–µ–∫
        </div>
        <div class="tab-item" onclick="switchTab('subs', this)">
            <span class="tab-icon">üîî</span>–ü–æ–¥–ø–∏—Å–∫–∏
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        const user_id = tg.initDataUnsafe?.user?.id || 12345;
        let SYMBOLS = {"RUB": "‚ÇΩ", "USD": "$", "EUR": "‚Ç¨"};
        let currentCurrency = "RUB";
        let currentPeriod = 'month';
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ñ–æ—Ä–º—ã –≤–≤–æ–¥–∞
        let currentType = 'expense';

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞—Ç (—Å–µ–≥–æ–¥–Ω—è)
        document.getElementById('sub-date').valueAsDate = new Date();
        document.getElementById('date-picker').valueAsDate = new Date();

        // 1. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¢–∏–ø–æ–º (–†–∞—Å—Ö–æ–¥/–î–æ—Ö–æ–¥)
        function setType(type) {
            currentType = type;
            // –ú–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ –∫–Ω–æ–ø–æ–∫
            document.getElementById('btn-exp').className = `type-btn ${type === 'expense' ? 'active-exp' : ''}`;
            document.getElementById('btn-inc').className = `type-btn ${type === 'income' ? 'active-inc' : ''}`;
            
            // –ú–µ–Ω—è–µ–º –≥–ª–∞–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
            const btn = document.getElementById('submit-btn');
            if (type === 'income') {
                btn.style.background = '#10b981';
                btn.innerText = '–ó–ê–†–ê–ë–û–¢–ê–õ!';
            } else {
                btn.style.background = '#ef4444';
                btn.innerText = '–ü–û–¢–†–ê–¢–ò–õ';
            }
        }

        function switchTab(screenName, btn) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab-item').forEach(b => b.classList.remove('active'));
            document.getElementById(`screen-${screenName}`).classList.add('active');
            btn.classList.add('active');
        }

        async function loadStats() {
            const res = await fetch(`/api/stats?user_id=${user_id}&period=${currentPeriod}`);
            const data = await res.json();
            
            currentCurrency = data.currency;
            document.getElementById('currency-select').value = data.currency;
            const sym = SYMBOLS[data.currency] || '';

            // –ö–û–®–ï–õ–ï–ö
            document.getElementById('total-balance').innerText = `${data.total_balance} ${sym}`;
            document.getElementById('inc-val').innerText = `+${data.period.income}`;
            document.getElementById('exp-val').innerText = `-${data.period.expense}`;
            
            const list = document.getElementById('history');
            list.innerHTML = "";
            data.history.forEach(item => {
                const color = item.type === 'income' ? '#10b981' : '#e2e8f0';
                const sign = item.type === 'income' ? '+' : '-';
                list.innerHTML += `<div style="padding:10px 0; border-bottom:1px solid #334155; display:flex; justify-content:space-between">
                    <span>${item.description}</span>
                    <span style="color:${color}; font-weight:bold">${sign}${item.amount} ${sym}</span>
                </div>`;
            });

            // –ü–û–î–ü–ò–°–ö–ò
            const subList = document.getElementById('subs-list');
            subList.innerHTML = "";
            if (data.subscriptions) {
                data.subscriptions.forEach(sub => {
                    const dateObj = new Date(sub.next_date);
                    const dateStr = dateObj.toLocaleDateString('ru-RU');
                    subList.innerHTML += `
                        <div class="sub-item">
                            <div>
                                <div style="font-weight:bold">${sub.name}</div>
                                <div style="font-size:12px; color:#94a3b8">–°–ª. –æ–ø–ª–∞—Ç–∞: ${dateStr}</div>
                            </div>
                            <div style="display:flex; align-items:center">
                                <div style="font-weight:bold; margin-right:10px">${sub.amount} ${sub.currency}</div>
                                <div class="sub-del" onclick="delSub(${sub.id})">√ó</div>
                            </div>
                        </div>
                    `;
                });
            }
        }

        async function sendData() {
            const input = document.getElementById('expense');
            const dateInput = document.getElementById('date-picker');
            
            if(!input.value) return;
            tg.HapticFeedback.impactOccurred('light');

            await fetch('/api/index', {
                method: 'POST',
                body: JSON.stringify({ 
                    text: input.value, 
                    user_id: user_id,
                    type: currentType, // –®–ª–µ–º —Ç–∏–ø (expense/income)
                    date: dateInput.value // –®–ª–µ–º –¥–∞—Ç—É
                })
            });
            input.value = "";
            loadStats();
        }

        function setFilter(p, el) { 
            currentPeriod = p; 
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active'); 
            loadStats(); 
        }
        
        async function changeCurrency() {
            const s = document.getElementById('currency-select');
            await fetch('/api/settings', { method: 'POST', body: JSON.stringify({ user_id: user_id, currency: s.value }) });
            loadStats();
        }

        async function addSub() {
            const name = document.getElementById('sub-name').value;
            const amount = document.getElementById('sub-amount').value;
            const date = document.getElementById('sub-date').value;
            const period = document.getElementById('sub-period').value;
            if(!name || !amount) return;

            await fetch('/api/subs', {
                method: 'POST',
                body: JSON.stringify({ action: 'add', user_id: user_id, name: name, amount: amount, currency: currentCurrency, date: date, period: period })
            });
            document.getElementById('sub-name').value = "";
            document.getElementById('sub-amount').value = "";
            tg.HapticFeedback.notificationOccurred('success');
            loadStats();
        }

        async function delSub(id) {
            if(!confirm("–£–¥–∞–ª–∏—Ç—å?")) return;
            await fetch('/api/subs', { method: 'POST', body: JSON.stringify({ action: 'delete', id: id }) });
            loadStats();
        }

        loadStats();
    </script>
</body>
</html>
