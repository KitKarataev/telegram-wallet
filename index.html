<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: -apple-system, BlinkMacSystemFont, sans-serif; padding: 15px; margin: 0; padding-bottom: 90px; user-select: none; }
        
        /* –°–≤–∞–π–ø-—ç–ª–µ–º–µ–Ω—Ç—ã (–ù–æ–≤–æ–µ!) */
        .swipe-wrapper { position: relative; margin-bottom: 10px; border-radius: 16px; overflow: hidden; background-color: #ef4444; /* –ö—Ä–∞—Å–Ω—ã–π —Ñ–æ–Ω —Å–Ω–∏–∑—É */ }
        
        .delete-layer { 
            position: absolute; top: 0; right: 0; bottom: 0; width: 80px; 
            display: flex; align-items: center; justify-content: center; 
            color: white; font-size: 24px; cursor: pointer; z-index: 1;
        }

        .history-item { 
            position: relative; 
            background: #1e293b; 
            padding: 15px; 
            display: flex; justify-content: space-between; align-items: center;
            z-index: 10; 
            transition: transform 0.2s ease-out; /* –ü–ª–∞–≤–Ω–æ—Å—Ç—å */
        }
        
        /* –ö–æ–≥–¥–∞ —Å–≤–∞–π–ø–Ω—É–ª–∏, —Å–¥–≤–∏–≥–∞–µ–º –≤–ª–µ–≤–æ */
        .history-item.swiped { transform: translateX(-80px); }

        /* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ (—Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã) */
        .tabs { position: fixed; bottom: 0; left: 0; width: 100%; background: #1e293b; display: flex; padding: 12px 0; border-top: 1px solid #334155; z-index: 100; padding-bottom: env(safe-area-inset-bottom); }
        .tab-item { flex: 1; text-align: center; color: #64748b; cursor: pointer; font-size: 11px; }
        .tab-item.active { color: #3b82f6; font-weight: bold; }
        .tab-icon { font-size: 22px; display: block; margin-bottom: 2px; }

        .screen { display: none; }
        .screen.active { display: block; }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .title { font-size: 20px; font-weight: 800; color: #fff; letter-spacing: -0.5px; }
        select { background: #1e293b; color: white; border: 1px solid #334155; padding: 6px 12px; border-radius: 10px; outline: none; font-weight: 500;}

        .wallet-card { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); padding: 25px; border-radius: 20px; text-align: center; margin-bottom: 20px; box-shadow: 0 10px 25px -5px rgba(37, 99, 235, 0.4); }
        .wallet-amount { font-size: 36px; font-weight: 800; color: white; margin-top: 5px; }

        .filters { display: flex; background: #1e293b; padding: 4px; border-radius: 14px; margin-bottom: 20px; }
        .filter-btn { flex: 1; text-align: center; padding: 8px 0; font-size: 13px; color: #94a3b8; border-radius: 10px; cursor: pointer; font-weight: 500; }
        .filter-btn.active { background: #334155; color: white; }

        .period-stats { display: flex; gap: 12px; margin-bottom: 25px; }
        .stat-card { flex: 1; background: #1e293b; padding: 15px; border-radius: 16px; }
        .stat-val { font-size: 18px; font-weight: bold; margin-top: 4px; }
        .green { color: #34d399; } .red { color: #f87171; }

        .input-box { background: #1e293b; padding: 20px; border-radius: 20px; margin-bottom: 25px; }
        .type-switch { display: flex; gap: 10px; margin-bottom: 15px; }
        .type-btn { flex: 1; padding: 12px; text-align: center; background: #334155; border-radius: 12px; font-size: 14px; cursor: pointer; color: #94a3b8; transition: 0.2s; font-weight: 600; }
        .type-btn.active-exp { background: #ef4444; color: white; }
        .type-btn.active-inc { background: #10b981; color: white; }

        input, select.full { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #334155; background: #0f172a; color: white; font-size: 16px; box-sizing: border-box; margin-bottom: 12px; outline: none; transition: 0.2s; }
        input:focus { border-color: #3b82f6; }
        
        button.main-btn { width: 100%; padding: 14px; background: #ef4444; color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; font-size: 16px; transition: transform 0.1s; touch-action: manipulation; }
        button.main-btn:active { transform: scale(0.98); }

        .sub-item { background: #1e293b; border-radius: 16px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #334155; }
        .export-btn { margin-top: 30px; text-align: center; padding: 15px; border: 1px dashed #334155; border-radius: 12px; color: #64748b; font-size: 14px; cursor: pointer; }
    </style>
</head>
<body>
    
    <div id="screen-wallet" class="screen active">
        <div class="header">
            <div class="title">–ú–æ–∏ –§–∏–Ω–∞–Ω—Å—ã</div>
            <select id="currency-select" onchange="changeCurrency()">
                <option value="RUB">RUB</option>
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
            </select>
        </div>

        <div class="wallet-card">
            <div style="font-size:13px; opacity:0.8; text-transform:uppercase; letter-spacing:1px">–û–±—â–∏–π –±–∞–ª–∞–Ω—Å</div>
            <div class="wallet-amount" id="total-balance">...</div>
        </div>

        <div class="filters">
            <div class="filter-btn" onclick="setFilter('day', this)">–î–µ–Ω—å</div>
            <div class="filter-btn" onclick="setFilter('week', this)">–ù–µ–¥–µ–ª—è</div>
            <div class="filter-btn active" onclick="setFilter('month', this)">–ú–µ—Å—è—Ü</div>
            <div class="filter-btn" onclick="setFilter('all', this)">–í—Å–µ</div>
        </div>

        <div class="period-stats">
            <div class="stat-card">
                <div style="font-size:12px; color:#94a3b8">–î–æ—Ö–æ–¥</div>
                <div id="inc-val" class="stat-val green">0</div>
            </div>
            <div class="stat-card">
                <div style="font-size:12px; color:#94a3b8">–†–∞—Å—Ö–æ–¥</div>
                <div id="exp-val" class="stat-val red">0</div>
            </div>
        </div>

        <div class="input-box">
            <div class="type-switch">
                <div id="btn-exp" class="type-btn active-exp" onclick="setType('expense')">–†–∞—Å—Ö–æ–¥</div>
                <div id="btn-inc" class="type-btn" onclick="setType('income')">–î–æ—Ö–æ–¥</div>
            </div>
            <input type="date" id="date-picker">
            <input type="text" id="expense" placeholder="–°—É–º–º–∞ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ...">
            <button class="main-btn" id="submit-btn" onclick="sendData()">–ü–û–¢–†–ê–¢–ò–õ</button>
        </div>
        
        <h3 style="color:#94a3b8; font-size:14px; margin-left:5px">–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h3>
        <div style="color:#64748b; font-size:12px; margin-left:5px; margin-bottom:10px">–°–º–∞—Ö–Ω–∏ –≤–ª–µ–≤–æ, —á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å ‚¨ÖÔ∏è</div>
        
        <div id="history"></div>

        <div class="export-btn" onclick="downloadReport()">
            üì• –°–∫–∞—á–∞—Ç—å –æ—Ç—á–µ—Ç (Excel/CSV)
        </div>
    </div>

    <div id="screen-subs" class="screen">
        <div class="header"><div class="title">–ü–æ–¥–ø–∏—Å–∫–∏</div></div>

        <div class="input-box">
            <input type="text" id="sub-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (Netflix)">
            <input type="number" id="sub-amount" placeholder="–°—É–º–º–∞ (19)">
            <div style="color:#94a3b8; font-size:12px; margin-bottom:8px">–î–∞—Ç–∞ —Å–ª–µ–¥—É—é—â–µ–π –æ–ø–ª–∞—Ç—ã:</div>
            <input type="date" id="sub-date">
            <select id="sub-period" class="full">
                <option value="month">–ö–∞–∂–¥—ã–π –º–µ—Å—è—Ü</option>
                <option value="year">–ö–∞–∂–¥—ã–π –≥–æ–¥</option>
            </select>
            <button class="main-btn" style="background:#3b82f6" onclick="addSub()">–î–û–ë–ê–í–ò–¢–¨</button>
        </div>

        <div id="subs-list"></div>
    </div>

    <div class="tabs">
        <div class="tab-item active" onclick="switchTab('wallet', this)">
            <span class="tab-icon">üí≥</span>–ö–æ—à–µ–ª–µ–∫
        </div>
        <div class="tab-item" onclick="switchTab('subs', this)">
            <span class="tab-icon">üîî</span>–ü–æ–¥–ø–∏—Å–∫–∏
        </div>
    </div>

    <script>
        const tg = window.Telegram?.WebApp;

        // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç –Ω–µ –≤–Ω—É—Ç—Ä–∏ Telegram ‚Äî –ø–æ–∫–∞–∂–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ (–∏–Ω–∞—á–µ –≤—Å—ë –±—É–¥–µ—Ç 401)
        if (!tg) {
            alert("–û—Ç–∫—Ä–æ–π —ç—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ Telegram");
        } else {
            tg.expand?.();
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ª–æ–≤–µ—Ü JS –æ—à–∏–±–æ–∫ ‚Äî –≤–º–µ—Å—Ç–æ "–ø—É—Å—Ç–æ–≥–æ —ç–∫—Ä–∞–Ω–∞"
        window.addEventListener("error", (e) => {
            console.error("JS ERROR:", e?.error || e?.message || e);
            alert("–û—à–∏–±–∫–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏: " + (e?.message || "—Å–º. console"));
        });

        let SYMBOLS = {"RUB": "‚ÇΩ", "USD": "$", "EUR": "‚Ç¨"};
        let currentCurrency = "RUB";
        let currentPeriod = 'month';
        let currentType = 'expense';

        document.getElementById('sub-date').valueAsDate = new Date();
        document.getElementById('date-picker').valueAsDate = new Date();

        // ===== AUTH + FETCH WRAPPER =====
        function tgInitData() {
            return tg?.initData || "";
        }

        async function tgFetch(url, options = {}) {
            const initData = tgInitData();
            if (!initData) {
                throw new Error("–ù–µ—Ç Telegram initData. –û—Ç–∫—Ä–æ–π WebApp –≤–Ω—É—Ç—Ä–∏ Telegram —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –±–æ—Ç–∞.");
            }

            const headers = new Headers(options.headers || {});
            if (options.body && !headers.has("Content-Type")) {
                headers.set("Content-Type", "application/json; charset=utf-8");
            }
            headers.set("X-Tg-Init-Data", initData);

            const res = await fetch(url, { ...options, headers });
            const text = await res.text();
            let parsed;
            try { parsed = JSON.parse(text); } catch { parsed = text; }

            if (!res.ok) {
                console.error("API error", res.status, parsed);
                throw new Error(parsed?.error || ("API error " + res.status));
            }
            return parsed;
        }
        // ===== END WRAPPER =====

        // --- –õ–û–ì–ò–ö–ê –°–í–ê–ô–ü–ê ---
        let touchStartX = 0;
        let touchEndX = 0;

        function addSwipeLogic(element) {
            element.addEventListener('touchstart', e => {
                touchStartX = e.changedTouches[0].screenX;
            });

            element.addEventListener('touchend', e => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe(element);
            });
        }

        function handleSwipe(element) {
            const swipeDistance = touchStartX - touchEndX;
            if (swipeDistance > 50) {
                document.querySelectorAll('.history-item.swiped').forEach(el => el.classList.remove('swiped'));
                element.classList.add('swiped');
                tg?.HapticFeedback?.selectionChanged?.();
            }
            if (swipeDistance < -50) {
                element.classList.remove('swiped');
            }
        }
        // -----------------------------

        function setType(type) {
            currentType = type;
            document.getElementById('btn-exp').className = `type-btn ${type === 'expense' ? 'active-exp' : ''}`;
            document.getElementById('btn-inc').className = `type-btn ${type === 'income' ? 'active-inc' : ''}`;
            const btn = document.getElementById('submit-btn');
            if (type === 'income') {
                btn.style.background = '#10b981';
                btn.innerText = '–ó–ê–†–ê–ë–û–¢–ê–õ!';
            } else {
                btn.style.background = '#ef4444';
                btn.innerText = '–ü–û–¢–†–ê–¢–ò–õ';
            }
        }

        function switchTab(screenName, btn) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab-item').forEach(b => b.classList.remove('active'));
            document.getElementById(`screen-${screenName}`).classList.add('active');
            btn.classList.add('active');
        }

        async function loadStats() {
            try {
                const res = await tgFetch(`/api/stats?period=${currentPeriod}`, { method: "GET" });
                const data = res?.data || res; // –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π

                currentCurrency = data.currency || "RUB";
                document.getElementById('currency-select').value = currentCurrency;
                const sym = SYMBOLS[currentCurrency] || '';

                document.getElementById('total-balance').innerText = `${data.total_balance ?? 0} ${sym}`;
                document.getElementById('inc-val').innerText = `+${data.period?.income ?? 0}`;
                document.getElementById('exp-val').innerText = `-${data.period?.expense ?? 0}`;

                const list = document.getElementById('history');
                list.innerHTML = "";

                const history = data.history || [];
                history.forEach(item => {
                    const color = item.type === 'income' ? '#10b981' : '#e2e8f0';
                    const sign = item.type === 'income' ? '+' : '-';
                    const dateObj = new Date(item.created_at);
                    const dateStr = dateObj.toLocaleDateString('ru-RU', {day:'numeric', month:'short'});

                    const wrapper = document.createElement('div');
                    wrapper.className = 'swipe-wrapper';

                    wrapper.innerHTML = `
                        <div class="delete-layer" onclick="deleteItem(${item.id})">üóë</div>
                        <div class="history-item">
                            <div>
                                <div style="font-weight:600; font-size:15px">${item.description}</div>
                                <div style="font-size:12px; color:#64748b; margin-top:2px">${dateStr} ‚Ä¢ ${item.category}</div>
                            </div>
                            <div style="color:${color}; font-weight:700; font-size:16px">${sign}${item.amount} ${sym}</div>
                        </div>
                    `;

                    const itemDiv = wrapper.querySelector('.history-item');
                    addSwipeLogic(itemDiv);

                    list.appendChild(wrapper);
                });

                const subList = document.getElementById('subs-list');
                subList.innerHTML = "";
                const subs = data.subscriptions || [];
                subs.forEach(sub => {
                    const dateObj = new Date(sub.next_date);
                    const dateStr = dateObj.toLocaleDateString('ru-RU');
                    subList.innerHTML += `
                        <div class="sub-item">
                            <div>
                                <div style="font-weight:bold">${sub.name}</div>
                                <div style="font-size:12px; color:#94a3b8">–°–ª. –æ–ø–ª–∞—Ç–∞: ${dateStr}</div>
                            </div>
                            <div style="display:flex; align-items:center">
                                <div style="font-weight:bold; margin-right:10px">${sub.amount} ${sub.currency}</div>
                                <div onclick="delSub(${sub.id})" style="color:#ef4444; font-size:24px; cursor:pointer">√ó</div>
                            </div>
                        </div>`;
                });

            } catch (e) {
                console.error(e);
                alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ: " + (e?.message || e));
            }
        }

        async function sendData() {
            const input = document.getElementById('expense');
            const dateInput = document.getElementById('date-picker');
            if(!input.value) return;

            // iPhone: –ø–µ—Ä–≤—ã–π —Ç–∞–ø —á–∞—Å—Ç–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –≤–º–µ—Å—Ç–æ –∫–ª–∏–∫–∞
            input.blur();
            dateInput.blur();

            tg?.HapticFeedback?.impactOccurred?.('light');

            try {
                await tgFetch('/api/index', {
                    method: 'POST',
                    body: JSON.stringify({
                        text: input.value,
                        type: currentType,
                        date: dateInput.value
                    })
                });

                input.value = "";
                await loadStats();
            } catch (e) {
                console.error(e);
                alert("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: " + (e?.message || e));
            }
        }

        function setFilter(p, el) { 
            currentPeriod = p; 
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active'); 
            loadStats(); 
        }
        
        async function changeCurrency() {
            const s = document.getElementById('currency-select');
            try {
                await tgFetch('/api/settings', {
                    method: 'POST',
                    body: JSON.stringify({ currency: s.value })
                });
                loadStats();
            } catch (e) {
                console.error(e);
                alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–∞–ª—é—Ç—ã: " + (e?.message || e));
            }
        }

        async function addSub() {
            const name = document.getElementById('sub-name').value;
            const amount = document.getElementById('sub-amount').value;
            const date = document.getElementById('sub-date').value;
            const period = document.getElementById('sub-period').value;
            if(!name || !amount) return;

            try {
                await tgFetch('/api/subs', {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'add',
                        name: name,
                        amount: amount,
                        currency: currentCurrency,
                        date: date,
                        period: period
                    })
                });

                document.getElementById('sub-name').value = "";
                document.getElementById('sub-amount').value = "";
                tg?.HapticFeedback?.notificationOccurred?.('success');
                loadStats();
            } catch (e) {
                console.error(e);
                alert("–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏: " + (e?.message || e));
            }
        }

        async function delSub(id) {
            if(!confirm("–£–¥–∞–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É?")) return;
            try {
                await tgFetch('/api/subs', {
                    method: 'POST',
                    body: JSON.stringify({ action: 'delete', id: id })
                });
                loadStats();
            } catch (e) {
                console.error(e);
                alert("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏: " + (e?.message || e));
            }
        }

        async function deleteItem(id) {
            if(!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?")) return;
            tg?.HapticFeedback?.notificationOccurred?.('error');
            try {
                await tgFetch('/api/delete', {
                    method: 'POST',
                    body: JSON.stringify({ id: id })
                });
                loadStats();
            } catch (e) {
                console.error(e);
                alert("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: " + (e?.message || e));
            }
        }

        async function downloadReport() {
            try {
                const initData = tgInitData();
                if (!initData) {
                    alert("–û—Ç–∫—Ä–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ Telegram");
                    return;
                }

                const res = await fetch('/api/export', {
                    method: "GET",
                    headers: { "X-Tg-Init-Data": initData }
                });

                if (!res.ok) {
                    const t = await res.text();
                    console.error("Export error", res.status, t);
                    alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å –æ—Ç—á–µ—Ç");
                    return;
                }

                const blob = await res.blob();
                const url = URL.createObjectURL(blob);

                const a = document.createElement("a");
                a.href = url;
                a.download = "finance_report.csv";
                document.body.appendChild(a);
                a.click();
                a.remove();

                URL.revokeObjectURL(url);
            } catch (e) {
                console.error(e);
                alert("–û—à–∏–±–∫–∞ –æ—Ç—á–µ—Ç–∞: " + (e?.message || e));
            }
        }

        // –°—Ç–∞—Ä—Ç
        loadStats();
    </script>
</body>
</html>