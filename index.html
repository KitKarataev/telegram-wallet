<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: -apple-system, sans-serif; padding: 15px; margin: 0; }
        
        /* Баланс Карточки */
        .balance-card { display: flex; justify-content: space-between; margin-bottom: 20px; gap: 10px; }
        .card { flex: 1; background: #1e293b; padding: 15px; border-radius: 12px; text-align: center; }
        .card h3 { margin: 0 0 5px 0; font-size: 12px; color: #94a3b8; }
        .card div { font-size: 16px; font-weight: bold; }
        .green { color: #10b981; } .red { color: #ef4444; }

        /* Ввод */
        .input-box { background: #1e293b; padding: 15px; border-radius: 16px; margin-bottom: 20px; }
        .type-switch { display: flex; background: #334155; border-radius: 10px; padding: 4px; margin-bottom: 10px; }
        .type-option { flex: 1; text-align: center; padding: 8px; border-radius: 8px; cursor: pointer; font-size: 14px; transition: 0.2s; color: #94a3b8; }
        .type-option.active { background: #3b82f6; color: white; font-weight: bold; }
        .type-option.active-red { background: #ef4444; color: white; font-weight: bold; }

        input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #334155; background: #0f172a; color: white; font-size: 16px; box-sizing: border-box; outline: none; }
        button.main-btn { width: 100%; margin-top: 10px; padding: 12px; background: #3b82f6; color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }

        /* История */
        .history-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #334155; align-items: center;}
        .del-btn { background: none; border: none; color: #64748b; font-size: 18px; cursor: pointer; padding-left: 10px; }
        
        .chart-container { height: 200px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="balance-card">
        <div class="card">
            <h3>Доход</h3>
            <div id="inc-val" class="green">0 ₽</div>
        </div>
        <div class="card">
            <h3>Расход</h3>
            <div id="exp-val" class="red">0 ₽</div>
        </div>
        <div class="card">
            <h3>Баланс</h3>
            <div id="bal-val">0 ₽</div>
        </div>
    </div>

    <div class="input-box">
        <div class="type-switch">
            <div id="btn-exp" class="type-option active-red" onclick="setType('expense')">Расход</div>
            <div id="btn-inc" class="type-option" onclick="setType('income')">Доход</div>
        </div>
        <input type="text" id="expense" placeholder="Например: Такси 500">
        <button class="main-btn" onclick="sendData()">ДОБАВИТЬ</button>
    </div>

    <div class="chart-container">
        <canvas id="myChart"></canvas>
    </div>

    <h3>История операций</h3>
    <div id="history"></div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        const user_id = tg.initDataUnsafe?.user?.id || 12345;
        let currentType = 'expense';
        let myChart = null;

        function setType(type) {
            currentType = type;
            document.getElementById('btn-exp').className = `type-option ${type === 'expense' ? 'active-red' : ''}`;
            document.getElementById('btn-inc').className = `type-option ${type === 'income' ? 'active' : ''}`;
            
            const btn = document.querySelector('.main-btn');
            btn.style.background = type === 'income' ? '#10b981' : '#ef4444';
            btn.innerText = type === 'income' ? 'ЗАРАБОТАЛ!' : 'ПОТРАТИЛ';
        }

        async function sendData() {
            const input = document.getElementById('expense');
            if(!input.value) return;
            tg.HapticFeedback.impactOccurred('light');

            await fetch('/api/index', {
                method: 'POST',
                body: JSON.stringify({ 
                    text: input.value, 
                    user_id: user_id,
                    type: currentType // Шлем тип (expense/income)
                })
            });
            input.value = "";
            loadStats();
        }

        async function deleteItem(id) {
            if(!confirm("Удалить?")) return;
            await fetch('/api/delete', { method: 'POST', body: JSON.stringify({ id: id }) });
            loadStats();
        }

        async function loadStats() {
            const res = await fetch(`/api/stats?user_id=${user_id}`);
            const data = await res.json();

            // Обновляем цифры
            document.getElementById('inc-val').innerText = `+${data.balance.income}`;
            document.getElementById('exp-val').innerText = `-${data.balance.expense}`;
            document.getElementById('bal-val').innerText = `${data.balance.total} ₽`;

            // График (Расходы)
            const ctx = document.getElementById('myChart');
            if (myChart) myChart.destroy();
            
            const chartData = data.chart.data.length ? data.chart.data : [1];
            const chartColors = data.chart.data.length ? ['#ef4444', '#f59e0b', '#3b82f6', '#8b5cf6'] : ['#334155'];

            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.chart.labels,
                    datasets: [{ data: chartData, backgroundColor: chartColors, borderWidth: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, cutout: '70%' }
            });

            // История
            const list = document.getElementById('history');
            list.innerHTML = "";
            data.history.forEach(item => {
                const isInc = item.type === 'income';
                const sign = isInc ? '+' : '-';
                const color = isInc ? '#10b981' : '#e2e8f0';
                
                list.innerHTML += `
                    <div class="history-item">
                        <div>
                            <div style="font-weight:bold">${item.description}</div>
                            <div style="font-size:12px; color:#64748b">${item.category}</div>
                        </div>
                        <div style="display:flex; align-items:center">
                            <span style="color:${color}; font-weight:bold; margin-right:10px">${sign}${item.amount}</span>
                            <button class="del-btn" onclick="deleteItem(${item.id})">×</button>
                        </div>
                    </div>`;
            });
        }
        loadStats();
    </script>
</body>
</html>
