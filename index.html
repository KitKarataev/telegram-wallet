<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: -apple-system, BlinkMacSystemFont, sans-serif; padding: 15px; margin: 0; padding-bottom: 90px; user-select: none; }
        
        /* –°–≤–∞–π–ø-—ç–ª–µ–º–µ–Ω—Ç—ã (–ù–æ–≤–æ–µ!) */
        .swipe-wrapper { position: relative; margin-bottom: 10px; border-radius: 16px; overflow: hidden; background-color: #ef4444; /* –ö—Ä–∞—Å–Ω—ã–π —Ñ–æ–Ω —Å–Ω–∏–∑—É */ }
        
        .delete-layer { 
            position: absolute; top: 0; right: 0; bottom: 0; width: 80px; 
            display: flex; align-items: center; justify-content: center; 
            color: white; font-size: 24px; cursor: pointer; z-index: 1;
        }

        .history-item { 
            position: relative; 
            background: #1e293b; 
            padding: 15px; 
            display: flex; justify-content: space-between; align-items: center;
            z-index: 10; 
            transition: transform 0.2s ease-out; /* –ü–ª–∞–≤–Ω–æ—Å—Ç—å */
        }
        
        /* –ö–æ–≥–¥–∞ —Å–≤–∞–π–ø–Ω—É–ª–∏, —Å–¥–≤–∏–≥–∞–µ–º –≤–ª–µ–≤–æ */
        .history-item.swiped { transform: translateX(-80px); }

        /* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ (—Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã) */
        .tabs { position: fixed; bottom: 0; left: 0; width: 100%; background: #1e293b; display: flex; padding: 12px 0; border-top: 1px solid #334155; z-index: 100; padding-bottom: env(safe-area-inset-bottom); }
        .tab-item { flex: 1; text-align: center; color: #64748b; cursor: pointer; font-size: 11px; }
        .tab-item.active { color: #3b82f6; font-weight: bold; }
        .tab-icon { font-size: 22px; display: block; margin-bottom: 2px; }

        .screen { display: none; }
        .screen.active { display: block; }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .title { font-size: 20px; font-weight: 800; color: #fff; letter-spacing: -0.5px; }
        select { background: #1e293b; color: white; border: 1px solid #334155; padding: 6px 12px; border-radius: 10px; outline: none; font-weight: 500;}

        .wallet-card { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); padding: 25px; border-radius: 20px; text-align: center; margin-bottom: 20px; box-shadow: 0 10px 25px -5px rgba(37, 99, 235, 0.4); }
        .wallet-amount { font-size: 36px; font-weight: 800; color: white; margin-top: 5px; }

        .filters { display: flex; background: #1e293b; padding: 4px; border-radius: 14px; margin-bottom: 20px; }
        .filter-btn { flex: 1; text-align: center; padding: 8px 0; font-size: 13px; color: #94a3b8; border-radius: 10px; cursor: pointer; font-weight: 500; }
        .filter-btn.active { background: #334155; color: white; }

        .period-stats { display: flex; gap: 12px; margin-bottom: 25px; }
        .stat-card { flex: 1; background: #1e293b; padding: 15px; border-radius: 16px; }
        .stat-val { font-size: 18px; font-weight: bold; margin-top: 4px; }
        .green { color: #34d399; } .red { color: #f87171; }

        .input-box { background: #1e293b; padding: 20px; border-radius: 20px; margin-bottom: 25px; }
        .type-switch { display: flex; gap: 10px; margin-bottom: 15px; }
        .type-btn { flex: 1; padding: 12px; text-align: center; background: #334155; border-radius: 12px; font-size: 14px; cursor: pointer; color: #94a3b8; transition: 0.2s; font-weight: 600; }
        .type-btn.active-exp { background: #ef4444; color: white; }
        .type-btn.active-inc { background: #10b981; color: white; }

        input, select.full { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #334155; background: #0f172a; color: white; font-size: 16px; box-sizing: border-box; margin-bottom: 12px; outline: none; transition: 0.2s; }
        input:focus { border-color: #3b82f6; }
        
        button.main-btn { width: 100%; padding: 14px; background: #ef4444; color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; font-size: 16px; transition: transform 0.1s; }
        button.main-btn:active { transform: scale(0.98); }

        .sub-item { background: #1e293b; border-radius: 16px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #334155; }
        .export-btn { margin-top: 30px; text-align: center; padding: 15px; border: 1px dashed #334155; border-radius: 12px; color: #64748b; font-size: 14px; cursor: pointer; }
    </style>
</head>
<body>
    
    <div id="screen-wallet" class="screen active">
        <div class="header">
            <div class="title">–ú–æ–∏ –§–∏–Ω–∞–Ω—Å—ã</div>
            <select id="currency-select" onchange="changeCurrency()">
                <option value="RUB">RUB</option>
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
            </select>
        </div>

        <div class="wallet-card">
            <div style="font-size:13px; opacity:0.8; text-transform:uppercase; letter-spacing:1px">–û–±—â–∏–π –±–∞–ª–∞–Ω—Å</div>
            <div class="wallet-amount" id="total-balance">...</div>
        </div>

        <div class="filters">
            <div class="filter-btn" onclick="setFilter('day', this)">–î–µ–Ω—å</div>
            <div class="filter-btn" onclick="setFilter('week', this)">–ù–µ–¥–µ–ª—è</div>
            <div class="filter-btn active" onclick="setFilter('month', this)">–ú–µ—Å—è—Ü</div>
            <div class="filter-btn" onclick="setFilter('all', this)">–í—Å–µ</div>
        </div>

        <div class="period-stats">
            <div class="stat-card">
                <div style="font-size:12px; color:#94a3b8">–î–æ—Ö–æ–¥</div>
                <div id="inc-val" class="stat-val green">0</div>
            </div>
            <div class="stat-card">
                <div style="font-size:12px; color:#94a3b8">–†–∞—Å—Ö–æ–¥</div>
                <div id="exp-val" class="stat-val red">0</div>
            </div>
        </div>

        <div class="input-box">
            <div class="type-switch">
                <div id="btn-exp" class="type-btn active-exp" onclick="setType('expense')">–†–∞—Å—Ö–æ–¥</div>
                <div id="btn-inc" class="type-btn" onclick="setType('income')">–î–æ—Ö–æ–¥</div>
            </div>
            <input type="date" id="date-picker">
            <input type="text" id="expense" placeholder="–°—É–º–º–∞ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ...">
            <button class="main-btn" id="submit-btn" onclick="sendData()">–ü–û–¢–†–ê–¢–ò–õ</button>
        </div>
        
        <h3 style="color:#94a3b8; font-size:14px; margin-left:5px">–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h3>
        <div style="color:#64748b; font-size:12px; margin-left:5px; margin-bottom:10px">–°–º–∞—Ö–Ω–∏ –≤–ª–µ–≤–æ, —á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å ‚¨ÖÔ∏è</div>
        
        <div id="history"></div>

        <div class="export-btn" onclick="downloadReport()">
            üì• –°–∫–∞—á–∞—Ç—å –æ—Ç—á–µ—Ç (Excel/CSV)
        </div>
    </div>

    <div id="screen-subs" class="screen">
        <div class="header"><div class="title">–ü–æ–¥–ø–∏—Å–∫–∏</div></div>

        <div class="input-box">
            <input type="text" id="sub-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (Netflix)">
            <input type="number" id="sub-amount" placeholder="–°—É–º–º–∞ (19)">
            <div style="color:#94a3b8; font-size:12px; margin-bottom:8px">–î–∞—Ç–∞ —Å–ª–µ–¥—É—é—â–µ–π –æ–ø–ª–∞—Ç—ã:</div>
            <input type="date" id="sub-date">
            <select id="sub-period" class="full">
                <option value="month">–ö–∞–∂–¥—ã–π –º–µ—Å—è—Ü</option>
                <option value="year">–ö–∞–∂–¥—ã–π –≥–æ–¥</option>
            </select>
            <button class="main-btn" style="background:#3b82f6" onclick="addSub()">–î–û–ë–ê–í–ò–¢–¨</button>
        </div>

        <div id="subs-list"></div>
    </div>

    <div class="tabs">
        <div class="tab-item active" onclick="switchTab('wallet', this)">
            <span class="tab-icon">üí≥</span>–ö–æ—à–µ–ª–µ–∫
        </div>
        <div class="tab-item" onclick="switchTab('subs', this)">
            <span class="tab-icon">üîî</span>–ü–æ–¥–ø–∏—Å–∫–∏
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        const user_id = tg.initDataUnsafe?.user?.id || 12345;
        let SYMBOLS = {"RUB": "‚ÇΩ", "USD": "$", "EUR": "‚Ç¨"};
        let currentCurrency = "RUB";
        let currentPeriod = 'month';
        let currentType = 'expense';

        document.getElementById('sub-date').valueAsDate = new Date();
        document.getElementById('date-picker').valueAsDate = new Date();

        // --- –õ–û–ì–ò–ö–ê –°–í–ê–ô–ü–ê (–ù–æ–≤–∞—è) ---
        let touchStartX = 0;
        let touchEndX = 0;

        function addSwipeLogic(element) {
            element.addEventListener('touchstart', e => {
                touchStartX = e.changedTouches[0].screenX;
            });

            element.addEventListener('touchend', e => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe(element);
            });
        }

        function handleSwipe(element) {
            const swipeDistance = touchStartX - touchEndX;
            // –ï—Å–ª–∏ —Å–≤–∞–π–ø–Ω—É–ª–∏ –≤–ª–µ–≤–æ –±–æ–ª—å—à–µ —á–µ–º –Ω–∞ 50px
            if (swipeDistance > 50) {
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ
                document.querySelectorAll('.history-item.swiped').forEach(el => el.classList.remove('swiped'));
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π
                element.classList.add('swiped');
                tg.HapticFeedback.selectionChanged();
            }
            // –ï—Å–ª–∏ —Å–≤–∞–π–ø–Ω—É–ª–∏ –≤–ø—Ä–∞–≤–æ - –∑–∞–∫—Ä—ã–≤–∞–µ–º
            if (swipeDistance < -50) {
                element.classList.remove('swiped');
            }
        }
        // -----------------------------

        function setType(type) {
            currentType = type;
            document.getElementById('btn-exp').className = `type-btn ${type === 'expense' ? 'active-exp' : ''}`;
            document.getElementById('btn-inc').className = `type-btn ${type === 'income' ? 'active-inc' : ''}`;
            const btn = document.getElementById('submit-btn');
            if (type === 'income') {
                btn.style.background = '#10b981';
                btn.innerText = '–ó–ê–†–ê–ë–û–¢–ê–õ!';
            } else {
                btn.style.background = '#ef4444';
                btn.innerText = '–ü–û–¢–†–ê–¢–ò–õ';
            }
        }

        function switchTab(screenName, btn) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab-item').forEach(b => b.classList.remove('active'));
            document.getElementById(`screen-${screenName}`).classList.add('active');
            btn.classList.add('active');
        }

        async function loadStats() {
            const res = await fetch(`/api/stats?user_id=${user_id}&period=${currentPeriod}`);
            const data = await res.json();
            
            currentCurrency = data.currency;
            document.getElementById('currency-select').value = data.currency;
            const sym = SYMBOLS[data.currency] || '';

            document.getElementById('total-balance').innerText = `${data.total_balance} ${sym}`;
            document.getElementById('inc-val').innerText = `+${data.period.income}`;
            document.getElementById('exp-val').innerText = `-${data.period.expense}`;
            
            // –†–µ–Ω–¥–µ—Ä –ò—Å—Ç–æ—Ä–∏–∏ —Å–æ –°–≤–∞–π–ø–∞–º–∏
            const list = document.getElementById('history');
            list.innerHTML = "";
            
            data.history.forEach(item => {
                const color = item.type === 'income' ? '#10b981' : '#e2e8f0';
                const sign = item.type === 'income' ? '+' : '-';
                const dateObj = new Date(item.created_at);
                const dateStr = dateObj.toLocaleDateString('ru-RU', {day:'numeric', month:'short'});

                // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —á–µ—Ä–µ–∑ JS, —á—Ç–æ–±—ã –Ω–∞–≤–µ—Å–∏—Ç—å —Å–æ–±—ã—Ç–∏—è
                const wrapper = document.createElement('div');
                wrapper.className = 'swipe-wrapper';

                wrapper.innerHTML = `
                    <div class="delete-layer" onclick="deleteItem(${item.id})">üóë</div>
                    <div class="history-item">
                        <div>
                            <div style="font-weight:600; font-size:15px">${item.description}</div>
                            <div style="font-size:12px; color:#64748b; margin-top:2px">${dateStr} ‚Ä¢ ${item.category}</div>
                        </div>
                        <div style="color:${color}; font-weight:700; font-size:16px">${sign}${item.amount} ${sym}</div>
                    </div>
                `;
                
                // –ù–∞—Ö–æ–¥–∏–º –≤–µ—Ä—Ö–Ω–∏–π —Å–ª–æ–π –∏ –¥–æ–±–∞–≤–ª—è–µ–º —Å–≤–∞–π–ø-–ª–æ–≥–∏–∫—É
                const itemDiv = wrapper.querySelector('.history-item');
                addSwipeLogic(itemDiv);
                
                list.appendChild(wrapper);
            });

            // –†–µ–Ω–¥–µ—Ä –ü–æ–¥–ø–∏—Å–æ–∫
            const subList = document.getElementById('subs-list');
            subList.innerHTML = "";
            if (data.subscriptions) {
                data.subscriptions.forEach(sub => {
                    const dateObj = new Date(sub.next_date);
                    const dateStr = dateObj.toLocaleDateString('ru-RU');
                    subList.innerHTML += `
                        <div class="sub-item">
                            <div>
                                <div style="font-weight:bold">${sub.name}</div>
                                <div style="font-size:12px; color:#94a3b8">–°–ª. –æ–ø–ª–∞—Ç–∞: ${dateStr}</div>
                            </div>
                            <div style="display:flex; align-items:center">
                                <div style="font-weight:bold; margin-right:10px">${sub.amount} ${sub.currency}</div>
                                <div onclick="delSub(${sub.id})" style="color:#ef4444; font-size:24px; cursor:pointer">√ó</div>
                            </div>
                        </div>`;
                });
            }
        }

        async function sendData() {
            const input = document.getElementById('expense');
            const dateInput = document.getElementById('date-picker');
            if(!input.value) return;
            tg.HapticFeedback.impactOccurred('light');
            await fetch('/api/index', { method: 'POST', body: JSON.stringify({ text: input.value, user_id: user_id, type: currentType, date: dateInput.value }) });
            input.value = "";
            loadStats();
        }

        function setFilter(p, el) { 
            currentPeriod = p; 
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active'); 
            loadStats(); 
        }
        
        async function changeCurrency() {
            const s = document.getElementById('currency-select');
            await fetch('/api/settings', { method: 'POST', body: JSON.stringify({ user_id: user_id, currency: s.value }) });
            loadStats();
        }

        async function addSub() {
            const name = document.getElementById('sub-name').value;
            const amount = document.getElementById('sub-amount').value;
            const date = document.getElementById('sub-date').value;
            const period = document.getElementById('sub-period').value;
            if(!name || !amount) return;
            await fetch('/api/subs', { method: 'POST', body: JSON.stringify({ action: 'add', user_id: user_id, name: name, amount: amount, currency: currentCurrency, date: date, period: period }) });
            document.getElementById('sub-name').value = ""; document.getElementById('sub-amount').value = "";
            tg.HapticFeedback.notificationOccurred('success');
            loadStats();
        }

        async function delSub(id) {
            if(!confirm("–£–¥–∞–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É?")) return;
            await fetch('/api/subs', { method: 'POST', body: JSON.stringify({ action: 'delete', id: id }) });
            loadStats();
        }

        // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Ç—Ä–∞—Ç—ã (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ –∫—Ä–∞—Å–Ω–æ–≥–æ —Å–ª–æ—è)
        async function deleteItem(id) {
            if(!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?")) return;
            tg.HapticFeedback.notificationOccurred('error');
            await fetch('/api/delete', { method: 'POST', body: JSON.stringify({ id: id }) });
            loadStats();
        }

        async function downloadReport() {
            const link = `/api/export?user_id=${user_id}`;
            if (tg.openLink) { tg.openLink(`https://${window.location.hostname}${link}`); } 
            else { window.location.href = link; }
        }

        loadStats();
    </script>
</body>
</html>
